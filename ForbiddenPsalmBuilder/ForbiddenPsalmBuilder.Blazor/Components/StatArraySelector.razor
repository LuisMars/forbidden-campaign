@namespace ForbiddenPsalmBuilder.Components

<div class="stat-array-selector">
    <h3>Stat Array Selection</h3>
    <p>Choose a predefined stat distribution and assign to your character's attributes:</p>

    @if (StatArrays.Any())
    {
        <div class="array-options">
            @foreach (var array in StatArrays)
            {
                <div class="array-option @(SelectedArrayId == array.Id ? "selected" : "")"
                     @onclick="() => SelectArray(array.Id)">
                    <h4>@array.Name</h4>
                    <p>@array.Description</p>
                    <div class="array-values horizontal gap-small">
                        @foreach (var value in array.Values)
                        {
                            <span class="stat-value @(value >= 0 ? "positive" : "negative")">
                                @(value >= 0 ? "+" : "")@value
                            </span>
                        }
                    </div>
                </div>
            }

            <div class="array-option @(SelectedArrayId == "unset" ? "selected" : "")"
                 @onclick="@(() => SelectArray("unset"))">
                <h4>Custom</h4>
                <p>Use manual override section below</p>
                <div class="array-values horizontal gap-small">
                    <span class="stat-value neutral">Custom</span>
                </div>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(SelectedArrayId) && SelectedArrayId != "unset")
        {
            <div class="stat-assignment">
                <h4>Assign Stats</h4>
                <p>Drag and drop or use dropdowns to assign the values [@(string.Join(", ", GetSelectedArray()?.Values.Select(v => (v >= 0 ? "+" : "") + v) ?? Array.Empty<string>()))] to your attributes:</p>

                <div class="assignment-grid">
                    <div class="stat-assignment-row">
                        <select @bind="AgilityIndex" class="stat-selector">
                            <option value="-1">-</option>
                            @for (int i = 0; i < (GetSelectedArray()?.Values.Length ?? 0); i++)
                            {
                                var value = GetSelectedArray()!.Values[i];
                                <option value="@i">@(value >= 0 ? "+" : "")@value</option>
                            }
                        </select>
                        <label>AGI</label>
                    </div>

                    <div class="stat-assignment-row">
                        <select @bind="PresenceIndex" class="stat-selector">
                            <option value="-1">-</option>
                            @for (int i = 0; i < (GetSelectedArray()?.Values.Length ?? 0); i++)
                            {
                                var value = GetSelectedArray()!.Values[i];
                                <option value="@i" disabled="@(IsIndexUsed(i, nameof(PresenceIndex)))">@(value >= 0 ? "+" : "")@value</option>
                            }
                        </select>
                        <label>PRE</label>
                    </div>

                    <div class="stat-assignment-row">
                        <select @bind="StrengthIndex" class="stat-selector">
                            <option value="-1">-</option>
                            @for (int i = 0; i < (GetSelectedArray()?.Values.Length ?? 0); i++)
                            {
                                var value = GetSelectedArray()!.Values[i];
                                <option value="@i" disabled="@(IsIndexUsed(i, nameof(StrengthIndex)))">@(value >= 0 ? "+" : "")@value</option>
                            }
                        </select>
                        <label>STR</label>
                    </div>

                    <div class="stat-assignment-row">
                        <select @bind="ToughnessIndex" class="stat-selector">
                            <option value="-1">-</option>
                            @for (int i = 0; i < (GetSelectedArray()?.Values.Length ?? 0); i++)
                            {
                                var value = GetSelectedArray()!.Values[i];
                                <option value="@i" disabled="@(IsIndexUsed(i, nameof(ToughnessIndex)))">@(value >= 0 ? "+" : "")@value</option>
                            }
                        </select>
                        <label>TOU</label>
                    </div>
                </div>

                @if (HasDuplicateAssignments())
                {
                    <div class="validation-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        Each stat value can only be used once. Please ensure all assignments are unique.
                    </div>
                }
            </div>
        }
        else if (SelectedArrayId == "unset")
        {
            <div class="stat-assignment">
                <h4>Manual Attribute Override</h4>
                <p>You can manually set the stats as needed:</p>

                <div class="assignment-grid">
                    <div class="stat-assignment-row">
                        <input type="number" @bind="ManualAgility" @bind:event="oninput" @onchange="OnManualStatChanged" class="stat-selector" min="-3" max="3" />
                        <label>AGI</label>
                    </div>

                    <div class="stat-assignment-row">
                        <input type="number" @bind="ManualPresence" @bind:event="oninput" @onchange="OnManualStatChanged" class="stat-selector" min="-3" max="3" />
                        <label>PRE</label>
                    </div>

                    <div class="stat-assignment-row">
                        <input type="number" @bind="ManualStrength" @bind:event="oninput" @onchange="OnManualStatChanged" class="stat-selector" min="-3" max="3" />
                        <label>STR</label>
                    </div>

                    <div class="stat-assignment-row">
                        <input type="number" @bind="ManualToughness" @bind:event="oninput" @onchange="OnManualStatChanged" class="stat-selector" min="-3" max="3" />
                        <label>TOU</label>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="no-arrays">
            <p>No stat arrays available for this game variant.</p>
            <p>You can set stats manually using the individual attribute inputs.</p>
        </div>
    }
</div>

@code {
    [Parameter] public List<ForbiddenPsalmBuilder.Core.Models.Character.StatArray> StatArrays { get; set; } = new();
    [Parameter] public EventCallback<(int Agility, int Presence, int Strength, int Toughness)> OnStatsChanged { get; set; }
    [Parameter] public EventCallback<string> OnArraySelectionChanged { get; set; }

    private string SelectedArrayId = string.Empty;
    private int AgilityIndex = -1;
    private int PresenceIndex = -1;
    private int StrengthIndex = -1;
    private int ToughnessIndex = -1;

    // Manual stat values
    private int ManualAgility = 0;
    private int ManualPresence = 0;
    private int ManualStrength = 0;
    private int ManualToughness = 0;

    protected override void OnParametersSet()
    {
        // Default to the first stat array (Specialist) instead of Custom
        if (string.IsNullOrEmpty(SelectedArrayId))
        {
            SelectedArrayId = StatArrays.FirstOrDefault()?.Id ?? "unset";
        }
    }

    private async Task SelectArray(string arrayId)
    {
        SelectedArrayId = arrayId;

        // Notify parent about array selection change
        await OnArraySelectionChanged.InvokeAsync(arrayId);

        if (arrayId == "unset")
        {
            // Don't apply any stat array, let user set manually
            await OnStatsChanged.InvokeAsync((0, 0, 0, 0));
        }
        else
        {
            // Reset assignments to default order
            AgilityIndex = 0;
            PresenceIndex = 1;
            StrengthIndex = 2;
            ToughnessIndex = 3;

            await NotifyStatsChanged();
        }
    }

    private ForbiddenPsalmBuilder.Core.Models.Character.StatArray? GetSelectedArray()
    {
        return StatArrays.FirstOrDefault(a => a.Id == SelectedArrayId);
    }

    private bool IsIndexUsed(int index, string excludeProperty)
    {
        var usedIndices = new List<int>();

        if (excludeProperty != nameof(AgilityIndex) && AgilityIndex >= 0) usedIndices.Add(AgilityIndex);
        if (excludeProperty != nameof(PresenceIndex) && PresenceIndex >= 0) usedIndices.Add(PresenceIndex);
        if (excludeProperty != nameof(StrengthIndex) && StrengthIndex >= 0) usedIndices.Add(StrengthIndex);
        if (excludeProperty != nameof(ToughnessIndex) && ToughnessIndex >= 0) usedIndices.Add(ToughnessIndex);

        return usedIndices.Contains(index);
    }

    private bool HasDuplicateAssignments()
    {
        var indices = new[] { AgilityIndex, PresenceIndex, StrengthIndex, ToughnessIndex }.Where(i => i >= 0).ToArray();
        return indices.Length != indices.Distinct().Count();
    }

    private async Task NotifyStatsChanged()
    {
        if (GetSelectedArray() == null) return;

        var array = GetSelectedArray()!;

        var agility = AgilityIndex >= 0 ? Math.Max(0, array.Values[AgilityIndex]) : 0;
        var presence = PresenceIndex >= 0 ? Math.Max(0, array.Values[PresenceIndex]) : 0;
        var strength = StrengthIndex >= 0 ? Math.Max(0, array.Values[StrengthIndex]) : 0;
        var toughness = ToughnessIndex >= 0 ? Math.Max(0, array.Values[ToughnessIndex]) : 0;

        await OnStatsChanged.InvokeAsync((agility, presence, strength, toughness));
    }

    private async Task OnManualStatChanged()
    {
        await OnStatsChanged.InvokeAsync((ManualAgility, ManualPresence, ManualStrength, ManualToughness));
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !string.IsNullOrEmpty(SelectedArrayId))
        {
            await NotifyStatsChanged();
        }
    }
}